{% extends "base.html" %}
{% load bonus_filters %}
{% load static %}
{% block meta %}
    <title>{{ robot.name }} - Roboteer's Tavern</title>
    <script src="{% static 'scripts/robot_detail.js' %}"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="{%static 'scripts/history_chart.js' %}"></script>
    <link rel="stylesheet" href="{% static 'style/robot_detail.css' %}">
{% endblock %}

{% block navbar %}
    {{block.super}}
    {% if is_random %}
        <div class="navlinks"><span class="random-robot"><a href="{% url 'main:randomRobot' %}"><span class="rand-question-mark">?</span></a></span></div>
    {%endif%}
{% endblock %}

{% block content %}
    <div class="main-content">
        {% if robot %}
            <div class="heading">
                <img class="flag-image" src="{{ robot.get_flag }}" alt="Flag">
                <h1 id="title">{{ robot.name }} {% if robot.display_latin_name %} <span class="alphanum">({{ robot.latin_name }})</span> {% endif %} </h1>
                {% if can_change %}
                <a href="{% url 'main:editRobot' robot.id %}"><img class="inline-image" src="{% static 'edit.png' %}" alt="Edit Robot"></a>
                <a href="{% url 'main:delete' 'robot' robot.id 0%}"><img class="inline-image" src="{% static 'bin.png' %}" alt="Delete Robot"></a>
                {% endif %}
            </div>
            {% if not robot.opt_out %}
                <h2>Rank: {{ robot.ranking|floatformat:2 }}
                    <span style="color:  {% if current_lb_entry.position == 1 %}gold
                                            {% elif current_lb_entry.position == 2 %}silver
                                            {% elif current_lb_entry.position == 3 %}darkgoldenrod
                                            {%else%}purple{% endif %}">{%if current_lb_entry %}#{{current_lb_entry.position}} {{current_lb_entry.wc_to_string}}{%endif%}</span>
                </h2>
                <h2>Win/Loss: {{ robot.wins }}/{{ robot.losses }}</h2>
            {% endif %}
            <p>{{ robot.description }}</p>

            {%if best_lb_entry%}
            <button id="best-lb-entry" onclick="toggleDropdown()" style="font-size:1.3em;font-weight: bold;margin:0px 0px 20px 0px;
                                    color:  {% if best_lb_entry.position == 1 %}gold
                                            {% elif best_lb_entry.position == 2 %}silver
                                            {% elif best_lb_entry.position == 3 %}darkgoldenrod
                                            {%else%}black{% endif %};
                                            border:none; padding:0px; background:none; {%if leaderboard_entries%}cursor:pointer{%endif%};
">Ranked #{{best_lb_entry.position}} {{best_lb_entry.wc_to_string}} in {{best_lb_entry.year}} {%if leaderboard_entries%}ðŸ Ÿ{%endif%}</button>
        <div id="all-lb-entries" style="display:none">
            {%for entry in leaderboard_entries%}
        <p style="color:  {% if entry.position == 1 %}gold
                                            {% elif entry.position == 2 %}silver
                                            {% elif entry.position == 3 %}darkgoldenrod
                                            {%else%}black{% endif %};
                                            {%if not forloop.last%}margin:2px 0px{%else%}margin:2px 0px 20px 0px{%endif%}">
            <span {%if entry.position < 10 %}style="margin-right:0.6em"{%endif%}> #{{entry.position}}</span> <span>{{entry.wc_to_string}} in {{entry.year}}</span></p>
            {%endfor%}
                        </div>
        {%endif%}

            <div>
                <div class="version tabs">
                    {% for v in version_set %}
                        <button class="tab-button{% if ver == v %} active{% elif not ver and forloop.last %} active{% endif %}"
                                id="but-{{ v.id }}" onclick="viewRobot({{ v.id }},{{ robot.id }})">
                            {% comment %}{% if v.robot_name == "" or v.robot_name == v.robot.name %}{{ v.name }}{% else %}{{ v.robot_name }}{% endif %}{% endcomment%}
                            {{ v.get_full_name }}

                        </button>
                    {% endfor %}
                </div>
                {% for v in version_set %}
                    <div class="version-block" id="ver-{{ v.id }}" {% if ver == v %}style="display:block"
                         {% elif not ver and forloop.last %}style="display:block"{% endif %}>
                        <div class="version-header">
                            <img class="flag-image" src="{{ v.get_flag }}" alt="Flag">
                            <p>{{ v }} {% if v.display_latin_name %}<span class="alphanum">({{ v.get_latin_name }})</span> {% endif %}
                                {% if can_change %}
                                <a href="{% url 'main:editVersion' v.id %}"><img class="inline-image" style="height:0.75em" src="{% static 'edit.png' %}" alt="Edit Version"></a>
                                <a href="{% url 'main:delete' 'version' v.id robot.id %}"><img class="inline-image" style="height:0.75em" src="{% static 'bin.png' %}" alt="Delete Version"></a>
                                {%endif%}
                            </p>
                        </div>

                        <div class="version-content">
                            <div class="version-image">
                                <img class="fit-image"
                                     src="{% if v.image %} {{ v.image.url }} {% else %} {% static 'unknown.png' %} {% endif %}"
                                     alt="Version Image">
                            </div>
                            <div class="version-text">
                                <div class="version-mini-head">
                                    <span>Weapon: {{ v.weapon_type }}</span>
                                    <span>Weight Class: {{ v.weight_class }}</span>
                                    <span>Competed:
                                        {% if v.first_fought|date:"F Y" == v.last_fought|date:"F Y" %}
                                            {{ v.first_fought|date:"F Y" }}
                                        {% elif v.first_fought|date:"Y" == v.last_fought|date:"Y" %}
                                            {{ v.first_fought|date:"F" }} - {{ v.last_fought|date:"F Y" }}
                                        {%else%}
                                            {{ v.first_fought|date:"F Y" }} - {{ v.last_fought|date:"F Y" }}
                                        {% endif %}</span>
                                {% if v.team %}
                                    <span>
                                        {%if v.loaned%}
                                            <em> Loaned To:
                                        {%else%}
                                            Team:
                                        {%endif%}
                                        <a href="{% url 'main:teamDetail' v.team.slug %}">{{ v.team }}</a>
                                        {%if v.loaned%}</em>{%endif%}
                                    </span>
                                {% endif %}
                                </div>
                                <div class="version-description">
                                    <p>{{ v.description }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% if can_change %}<a class="editor-link" href="{% url 'main:newVersion' robot.id %}">Add New Version</a>{% endif %}
            </div>
        <span id="robot-slug" robot-slug="{{robot.slug}}" hidden="hidden"></span>
        <div id="history-chart" style="width:100%; height:400px;"></div>

            {% if awards|length > 0 or robot.hallofame_set.all|length > 0 %}
                {%if robot.hallofame_set.all|length > 0%}
                <h2>{{ robot }} has won {{ awards|length|add:"1" }} {% if awards|length == 0 %}award. {% else %} awards.{% endif %}</h2>
                {%else%}
                <h2>{{ robot }} has won {{ awards|length }} {% if awards|length == 1 %}award. {% else %} awards.{% endif %}</h2>
                {%endif%}
                <table>
                    <thead>
                    <tr>
                        <th></th>
                        <th>Award Name</th>
                        <th>Event</th>
                    </tr>
                    </thead>
                    {%if robot.hallofame_set.all|length > 0%}
                    <td><img class="award-icon" src="{%static 'awards/frame2.png'%}" alt="award icon"></td>
                    <td colspan="2" style="text-align:center"><a href="{%url 'main:hallOfFame' %}">{%if robot.hallofame_set.first.full_member%}Hall of Fame Member{%else%}Hall of Fame Honorable Mention{%endif%}</a></td>
                    {% endif %}
                    {% for award in awards %}
                        <tr>
                            <td><img class="award-icon" src="{{ award.get_icon }}" alt="award icon"></td>
                            <td>{{ award }}</td>
                            <td>{{ award.contest.event }}</td>
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}

            {% if fights|length > 0 %}
                <h2>{% if robot.display_latin_name %} {{ robot.latin_name }} {% else %}{{ robot }} {% endif %}
                    has fought {{ fights|length }} {% if fights|length == 1 %}fight. {% else %}fights.{% endif %}</h2>
                <table>
                    <thead>
                    <tr>
                        <th>Event</th>
                        <th>Type</th>
                        <th>Opponents</th>
                        <th>Result</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for fight in fights %}
                        <tr>
                            {% with fights|fights_event_number:fight as num_fights %}
                                {% if num_fights != -1 %}
                                    <td rowspan="{{ num_fights }}" style="background-color: white">
                                        <a href="{% url 'main:eventDetail' fight.contest.event.slug %}">{{ fight.contest.event }}</a>
                                    </td>
                                {% endif %}
                            {% endwith %}
                            <td>{{ fight.get_fight_type_display }}</td>
                            <td><a class="fight-link" style="display:inline-flex" href="{% url 'main:fightDetail' fight.id %}">
                                {{ fight|fight_opponents:robot }}
                                {%if fight.img_gif_vid == 'image'%}
                                    <img class="fight-link-icon" src="{%static 'media_icons/image.svg'%}" alt="This fight has an image">
                                {%elif fight.img_gif_vid == 'gif'%}
                                    <img class="fight-link-icon fight-link-icon-gif" src="{%static 'media_icons/gif.svg'%}" alt="This fight has a gif">
                                {%elif fight.img_gif_vid == 'video'%}
                                    <img class="fight-link-icon" src="{%static 'media_icons/video.svg'%}" alt="This fight has a video">
                                {%endif%}
                            </a></td>
                            <td>{{ fight|fight_result:robot }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}

        {% else %}
            Something appears to have gone wrong
        {% endif %}
    </div>
{% endblock %}
